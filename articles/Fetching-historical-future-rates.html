<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>How to Compute Historical Rates from B3 Future Prices • rb3</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="How to Compute Historical Rates from B3 Future Prices">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-primary" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">rb3</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-vignettes" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Vignettes</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-vignettes">
<li><a class="dropdown-item" href="../articles/Getting-started.html">Getting Started</a></li>
    <li><a class="dropdown-item" href="../articles/Fetching-historical-equity-data.html">Fetching Historical Equity Data</a></li>
    <li><a class="dropdown-item" href="../articles/Fetching-historical-index-data.html">Analyzing B3 Index Data</a></li>
    <li><a class="dropdown-item" href="../articles/Fetching-historical-future-rates.html">How to Compute Historical Rates from B3 Future Prices</a></li>
    <li><a class="dropdown-item" href="../articles/Fetching-historical-yield-curve.html">Fetching B3 Yield Curves</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/ropensci/rb3/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>How to Compute Historical Rates from B3 Future Prices</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/ropensci/rb3/blob/main/vignettes/Fetching-historical-future-rates.Rmd" class="external-link"><code>vignettes/Fetching-historical-future-rates.Rmd</code></a></small>
      <div class="d-none name"><code>Fetching-historical-future-rates.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>The template <code>b3-futures-settlement-prices</code> allows you to
fetch historical settlement prices for future contracts from B3 (Brasil,
Bolsa, Balcão), the Brazilian stock exchange and derivatives market.
This vignette provides a step-by-step guide on how to retrieve, process,
and analyze this data using the <code>rb3</code> package.</p>
<p>The futures contract settlement prices are published daily by B3.
These settlement prices represent the official daily closing values used
for marking positions to market and calculating margin requirements.</p>
<p>The data is publicly available on the B3 website through their <a href="https://www.b3.com.br/en_us/market-data-and-indices/data-services/market-data/historical-data/derivatives/trading-session-settlements/" title="Trading session settlements" class="external-link">Trading session settlements</a>
page. This page provides one of the longest available historical records
of futures contract prices. We’ll use this historical pricing data to
analyze trends, term structures, and other patterns in Brazilian futures
markets.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://docs.ropensci.org/rb3" class="external-link">rb3</a></span><span class="op">)</span> <span class="co"># B3 data access</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span> <span class="co"># data visualization</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://stringr.tidyverse.org" class="external-link">stringr</a></span><span class="op">)</span> <span class="co"># string manipulation</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span> <span class="co"># data transformation</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/wilsonfreitas/R-bizdays" class="external-link">bizdays</a></span><span class="op">)</span> <span class="co"># business days calculations</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="fetching-historical-data">Fetching historical data<a class="anchor" aria-label="anchor" href="#fetching-historical-data"></a>
</h2>
<p>To analyze historical futures data, we’ll collect settlement prices
at regular intervals. We’ll fetch data for the first Monday of each week
over a two-year period (2021-2022).</p>
<p>First, we generate a sequence of dates representing first Mondays
from January 2021 through December 2022. We then adjust these dates
using the <code><a href="https://rdrr.io/pkg/bizdays/man/adjust.date.html" class="external-link">following()</a></code> function from the
<code>bizdays</code> package to ensure we only get valid trading days on
the B3 calendar. We use “first mon” to select Mondays and a 7-day
interval for weekly samples. This provides regular sampling points while
keeping the dataset manageable.</p>
<p>After selecting our dates, we use the <code><a href="../reference/fetch_marketdata.html">fetch_marketdata()</a></code>
function from the <code>rb3</code> package to:</p>
<ul>
<li>Download the futures settlement prices data from B3’s website</li>
<li>Parse the raw data into a structured format</li>
<li>Store it in the <code>rb3</code> package’s internal database for
efficient queries</li>
</ul>
<p>This process avoids repeated downloads and provides consistent access
to the data. The stored data creates the dataset
<code>b3-futures-settlement-prices</code>, which can be queried and
analyzed efficiently.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dates</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/bizdays/man/getdate.html" class="external-link">getdate</a></span><span class="op">(</span><span class="st">"first mon"</span>, <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="st">"2021-01-01"</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="st">"2022-12-24"</span><span class="op">)</span>, by <span class="op">=</span> <span class="fl">7</span><span class="op">)</span>, <span class="st">"actual"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/bizdays/man/adjust.date.html" class="external-link">following</a></span><span class="op">(</span><span class="st">"Brazil/B3"</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/fetch_marketdata.html">fetch_marketdata</a></span><span class="op">(</span><span class="st">"b3-futures-settlement-prices"</span>, refdate <span class="op">=</span> <span class="va">dates</span><span class="op">)</span></span></code></pre></div>
<p>By leveraging the rb3 and bizdays packages together, we can
efficiently manage and analyze historical market data from B3, enabling
us to explore various aspects of the Brazilian financial markets.</p>
<div class="section level3">
<h3 id="querying-the-data">Querying the data<a class="anchor" aria-label="anchor" href="#querying-the-data"></a>
</h3>
<p>After fetching the historical futures data, we can query it using the
<code><a href="../reference/futures_get.html">futures_get()</a></code> function from the <code>rb3</code> package.
This function allows us to retrieve the data stored in the internal
database efficiently. Note that <code><a href="../reference/futures_get.html">futures_get()</a></code> uses lazy
evaluation, meaning it only loads the data when explicitly
requested.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Retrieve the futures settlement prices data</span></span>
<span><span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/futures_get.html">futures_get</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/compute.html" class="external-link">collect</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>Call the <code><a href="../reference/futures_get.html">futures_get()</a></code> function to retrieve the dataset.
Then, use the <code><a href="https://dplyr.tidyverse.org/reference/compute.html" class="external-link">collect()</a></code> function to load the data into a
data frame for further analysis.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Display the first few rows of the dataset</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">df</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 6 × 8</span></span></span>
<span><span class="co">#&gt;   refdate    symbol commodity maturity_code previous_price  price price_change</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>                  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>        <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> 2021-01-04 AFSF21 AFS       F21                   <span style="text-decoration: underline;">14</span>605  <span style="text-decoration: underline;">14</span>605           0  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> 2021-01-04 AFSG21 AFS       G21                   <span style="text-decoration: underline;">14</span>670. <span style="text-decoration: underline;">14</span>747          76.7</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> 2021-01-04 AFSH21 AFS       H21                   <span style="text-decoration: underline;">14</span>718. <span style="text-decoration: underline;">14</span>792.         74.8</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> 2021-01-04 AFSJ21 AFS       J21                   <span style="text-decoration: underline;">14</span>783. <span style="text-decoration: underline;">14</span>853.         70.2</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span> 2021-01-04 AFSK21 AFS       K21                   <span style="text-decoration: underline;">14</span>831. <span style="text-decoration: underline;">14</span>903.         71.5</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">6</span> 2021-01-04 AFSM21 AFS       M21                   <span style="text-decoration: underline;">14</span>880. <span style="text-decoration: underline;">14</span>953.         73.2</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 1 more variable: settlement_value &lt;dbl&gt;</span></span></span></code></pre></div>
<p>In this example, we see how to use the function
<code><a href="../reference/futures_get.html">futures_get()</a></code> to access the data stored in the
<code>b3-futures-settlement-prices</code> dataset.</p>
<p>This queried data can now be used for further analysis, such as
calculating historical nominal and real interest rates, implied
inflation, and forward rates.</p>
</div>
</div>
<div class="section level2">
<h2 id="historical-nominal-interest-rates">Historical nominal interest rates<a class="anchor" aria-label="anchor" href="#historical-nominal-interest-rates"></a>
</h2>
<p>Interest rates can be derived from the prices of futures contracts.
DI1 contracts mature on the first day of the month. The code below
generates the maturity dates from the three characters of the maturity
code. Then, we calculate the implied rates considering that the notional
value of the contracts is 100000.</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext mathvariant="normal">Adjusted Rate</mtext><mo>=</mo><msup><mrow><mo stretchy="true" form="prefix">(</mo><mfrac><mn>100000</mn><mtext mathvariant="normal">Price</mtext></mfrac><mo stretchy="true" form="postfix">)</mo></mrow><mfrac><mn>252</mn><mtext mathvariant="normal">Business Days</mtext></mfrac></msup><mo>−</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">
\text{Adjusted Rate} = \left(\frac{100000}{\text{Price}}\right)^{\frac{252}{\text{Business Days}}} - 1
</annotation></semantics></math></p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">di1_futures</span> <span class="op">&lt;-</span> <span class="va">df</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">commodity</span> <span class="op">==</span> <span class="st">"DI1"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    maturity_date <span class="op">=</span> <span class="fu"><a href="../reference/maturity2date.html">maturity2date</a></span><span class="op">(</span><span class="va">maturity_code</span><span class="op">)</span>,</span>
<span>    fixing <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/bizdays/man/adjust.date.html" class="external-link">following</a></span><span class="op">(</span><span class="va">maturity_date</span>, <span class="st">"Brazil/ANBIMA"</span><span class="op">)</span>,</span>
<span>    business_days <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/bizdays/man/bizdays.html" class="external-link">bizdays</a></span><span class="op">(</span><span class="va">refdate</span>, <span class="va">maturity_date</span>, <span class="st">"Brazil/ANBIMA"</span><span class="op">)</span>,</span>
<span>    adjusted_tax <span class="op">=</span> <span class="op">(</span><span class="fl">100000</span> <span class="op">/</span> <span class="va">price</span><span class="op">)</span><span class="op">^</span><span class="op">(</span><span class="fl">252</span> <span class="op">/</span> <span class="va">business_days</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">business_days</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span></span></code></pre></div>
<p>In the graph below we see the dynamics of the nominal interest rates
of the contracts DI1F23 and DI1F33. These contracts are exactly 10 years
distant from each other.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">di1_futures</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">symbol</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"DI1F23"</span>, <span class="st">"DI1F33"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">refdate</span>, y <span class="op">=</span> <span class="va">adjusted_tax</span>, color <span class="op">=</span> <span class="va">symbol</span>, group <span class="op">=</span> <span class="va">symbol</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span></span>
<span>    title <span class="op">=</span> <span class="st">"DI1 Future Rates - Nominal Interest Rates"</span>,</span>
<span>    caption <span class="op">=</span> <span class="st">"Source B3 - package rb3"</span>,</span>
<span>    x <span class="op">=</span> <span class="st">"Date"</span>,</span>
<span>    y <span class="op">=</span> <span class="st">"Interest Rates"</span>,</span>
<span>    color <span class="op">=</span> <span class="st">"Symbol"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_continuous</a></span><span class="op">(</span>labels <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="va"><a href="https://scales.r-lib.org/reference/percent_format.html" class="external-link">percent</a></span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<img src="Fetching-historical-future-rates_files/figure-html/di1-futures-plot-1.png" alt="DI1 Future Rates - Nominal Interest Rates" width="672"><p class="caption">
DI1 Future Rates - Nominal Interest Rates
</p>
</div>
</div>
<div class="section level2">
<h2 id="historical-real-interest-rates">Historical real interest rates<a class="anchor" aria-label="anchor" href="#historical-real-interest-rates"></a>
</h2>
<p>Differently from DI1 contracts, that trade nominal interest rates,
the DAP contracts trade real interest rates. DAP contracts matures on
the 15th day of the month. The code below generates the maturity dates
from the three characters of the maturity code. Then, we calculate the
implied rates considering that the notional value of the contracts is
100000, exactly as we did for the DI1 contracts.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dap_futures</span> <span class="op">&lt;-</span> <span class="va">df</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">commodity</span> <span class="op">==</span> <span class="st">"DAP"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    maturity_date <span class="op">=</span> <span class="fu"><a href="../reference/maturity2date.html">maturity2date</a></span><span class="op">(</span><span class="va">maturity_code</span>, <span class="st">"15th day"</span><span class="op">)</span>,</span>
<span>    fixing <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/bizdays/man/adjust.date.html" class="external-link">following</a></span><span class="op">(</span><span class="va">maturity_date</span>, <span class="st">"Brazil/ANBIMA"</span><span class="op">)</span>,</span>
<span>    business_days <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/bizdays/man/bizdays.html" class="external-link">bizdays</a></span><span class="op">(</span><span class="va">refdate</span>, <span class="va">maturity_date</span>, <span class="st">"Brazil/ANBIMA"</span><span class="op">)</span>,</span>
<span>    adjusted_tax <span class="op">=</span> <span class="op">(</span><span class="fl">100000</span> <span class="op">/</span> <span class="va">price</span><span class="op">)</span><span class="op">^</span><span class="op">(</span><span class="fl">252</span> <span class="op">/</span> <span class="va">business_days</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">business_days</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span></span></code></pre></div>
<p>The graphic below shows the dynamics of the real interest rates of
the contracts DAPF23 and DAPK35. These contracts are exactly 12 years
distant from each other. Since we don’t have a 10-year contract, we use
the 12-year contract as a reference to observe the dynamics of short and
long term real interest rates.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dap_futures</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">symbol</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"DAPF23"</span>, <span class="st">"DAPK35"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">refdate</span>, y <span class="op">=</span> <span class="va">adjusted_tax</span>, group <span class="op">=</span> <span class="va">symbol</span>, color <span class="op">=</span> <span class="va">symbol</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span></span>
<span>    title <span class="op">=</span> <span class="st">"DAP Future Rates - Real Interest Rates"</span>,</span>
<span>    caption <span class="op">=</span> <span class="st">"Source B3 - package rb3"</span>,</span>
<span>    x <span class="op">=</span> <span class="st">"Date"</span>,</span>
<span>    y <span class="op">=</span> <span class="st">"Interest Rates"</span>,</span>
<span>    color <span class="op">=</span> <span class="st">"Symbol"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_continuous</a></span><span class="op">(</span>labels <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="va"><a href="https://scales.r-lib.org/reference/percent_format.html" class="external-link">percent</a></span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<img src="Fetching-historical-future-rates_files/figure-html/dap-futures-plot-1.png" alt="DAP Future Rates - Real Interest Rates" width="672"><p class="caption">
DAP Future Rates - Real Interest Rates
</p>
</div>
</div>
<div class="section level2">
<h2 id="implied-inflation">Implied inflation<a class="anchor" aria-label="anchor" href="#implied-inflation"></a>
</h2>
<p>By comparing the real and nominal interest rates, we can derive the
forward inflation implied in these contracts. Specifically, we use the
DI1F23 and DAPF23 contracts, which mature in the same month with only a
few days’ difference. The implied inflation can be calculated by
dividing the prices of these contracts.</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext mathvariant="normal">Inflation</mtext><mo>≈</mo><mfrac><mtext mathvariant="normal">DAPF23</mtext><mtext mathvariant="normal">DI1F23</mtext></mfrac><mo>−</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">
\text{Inflation} \approx \frac{\text{DAPF23}}{\text{DI1F23}} - 1
</annotation></semantics></math></p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">infl_futures</span> <span class="op">&lt;-</span> <span class="va">df</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">symbol</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"DI1F23"</span>, <span class="st">"DAPF23"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">infl_expec</span> <span class="op">&lt;-</span> <span class="va">infl_futures</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">symbol</span>, <span class="va">price</span>, <span class="va">refdate</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_wider.html" class="external-link">pivot_wider</a></span><span class="op">(</span>names_from <span class="op">=</span> <span class="va">symbol</span>, values_from <span class="op">=</span> <span class="va">price</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>inflation <span class="op">=</span> <span class="va">DAPF23</span> <span class="op">/</span> <span class="va">DI1F23</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">infl_expec</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">refdate</span>, y <span class="op">=</span> <span class="va">inflation</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="st">"Date"</span>, y <span class="op">=</span> <span class="st">"Inflation"</span>,</span>
<span>    title <span class="op">=</span> <span class="st">"Implied Inflation from futures DI1F23, DAPF23"</span>,</span>
<span>    caption <span class="op">=</span> <span class="st">"Source B3 - package rb3"</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<div class="figure">
<img src="Fetching-historical-future-rates_files/figure-html/implied-inflation-plot-1.png" alt="Implied Inflation from futures" width="672"><p class="caption">
Implied Inflation from futures
</p>
</div>
<p>We can observe that, as the contracts approach maturity, the implied
inflation converges to zero, as expected. To overcome this bias, let’s
redo the graph for the F24 maturity.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">df</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">symbol</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"DI1F24"</span>, <span class="st">"DAPF24"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">symbol</span>, <span class="va">price</span>, <span class="va">refdate</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_wider.html" class="external-link">pivot_wider</a></span><span class="op">(</span>names_from <span class="op">=</span> <span class="va">symbol</span>, values_from <span class="op">=</span> <span class="va">price</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>inflation <span class="op">=</span> <span class="va">DAPF24</span> <span class="op">/</span> <span class="va">DI1F24</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/na.fail.html" class="external-link">na.omit</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">refdate</span>, y <span class="op">=</span> <span class="va">inflation</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="st">"Date"</span>, y <span class="op">=</span> <span class="st">"Inflation"</span>,</span>
<span>    title <span class="op">=</span> <span class="st">"Implied Inflation from futures DI1F24, DAPF24"</span>,</span>
<span>    caption <span class="op">=</span> <span class="st">"Source B3 - package rb3"</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<div class="figure">
<img src="Fetching-historical-future-rates_files/figure-html/implied-inflation-F24-1.png" alt="Implied Inflation from futures" width="672"><p class="caption">
Implied Inflation from futures
</p>
</div>
</div>
<div class="section level2">
<h2 id="forward-rates">Forward rates<a class="anchor" aria-label="anchor" href="#forward-rates"></a>
</h2>
<p>The 10-year forward rates implied in DI1 futures prices can be
computed using the DI1F23 and DI1F33 contracts. These contracts are used
to calculate the 10-year forward rates, which range from January 2023 to
January 2033.</p>
<p>Here it follows the steps to calculate the forward rates.</p>
<ol style="list-style-type: decimal">
<li>Filter Data: filter the dataframe df to include only rows where the
symbol is either “DI1F23” or “DI1F33”. Save this filtered dataframe in a
new dataframe called <code>df_fut</code>.</li>
</ol>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">df_fut</span> <span class="op">&lt;-</span> <span class="va">df</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">symbol</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"DI1F23"</span>, <span class="st">"DI1F33"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<ol start="2" style="list-style-type: decimal">
<li>Calculate Maturity Date and Business Days: convert the maturity_code
to maturity_date and adjust it to the next business day according to the
“Brazil/ANBIMA” calendar. Calculate the number of business days between
the reference date (refdate) and the maturity date.</li>
</ol>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">df_fut</span> <span class="op">&lt;-</span> <span class="va">df_fut</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    maturity_date <span class="op">=</span> <span class="fu"><a href="../reference/maturity2date.html">maturity2date</a></span><span class="op">(</span><span class="va">maturity_code</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/pkg/bizdays/man/adjust.date.html" class="external-link">following</a></span><span class="op">(</span><span class="st">"Brazil/ANBIMA"</span><span class="op">)</span>,</span>
<span>    business_days <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/bizdays/man/bizdays.html" class="external-link">bizdays</a></span><span class="op">(</span><span class="va">refdate</span>, <span class="va">maturity_date</span>, <span class="st">"Brazil/ANBIMA"</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<ol start="3" style="list-style-type: decimal">
<li>Calculate the Difference in Business Days: calculate the difference
in business days between the DI1F23 and DI1F33 contracts. Save this
information in a new dataframe called <code>df_du</code>.</li>
</ol>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">df_du</span> <span class="op">&lt;-</span> <span class="va">df_fut</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">refdate</span>, <span class="va">symbol</span>, <span class="va">business_days</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_wider.html" class="external-link">pivot_wider</a></span><span class="op">(</span>names_from <span class="op">=</span> <span class="va">symbol</span>, values_from <span class="op">=</span> <span class="va">business_days</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    du <span class="op">=</span> <span class="va">DI1F33</span> <span class="op">-</span> <span class="va">DI1F23</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">refdate</span>, <span class="va">du</span><span class="op">)</span></span></code></pre></div>
<ol start="4" style="list-style-type: decimal">
<li>Join Dataframes: join the <code>df_fut</code> and <code>df_du</code>
dataframes by the <code>refdate</code> column. Select only the
<code>refdate</code>, <code>symbol</code>, and <code>price</code>
columns from the <code>df_fut</code> dataframe. Pivot the
<code>df_fut</code> dataframe to have the <code>symbol</code> as columns
and the <code>price</code> as values. Now we have the prices of the
futures and the business days between them, for each date, in the same
row.</li>
</ol>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">df_fut</span> <span class="op">&lt;-</span> <span class="va">df_fut</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">refdate</span>, <span class="va">symbol</span>, <span class="va">price</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_wider.html" class="external-link">pivot_wider</a></span><span class="op">(</span>names_from <span class="op">=</span> <span class="va">symbol</span>, values_from <span class="op">=</span> <span class="va">price</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">inner_join</a></span><span class="op">(</span><span class="va">df_du</span>, by <span class="op">=</span> <span class="st">"refdate"</span><span class="op">)</span></span></code></pre></div>
<ol start="5" style="list-style-type: decimal">
<li>Calculate the Forward Rates: calculate the 10-year forward rates
using the formula below.</li>
</ol>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext mathvariant="normal">Forward Rate</mtext><mo>=</mo><msup><mrow><mo stretchy="true" form="prefix">(</mo><mfrac><mtext mathvariant="normal">DI1F23</mtext><mtext mathvariant="normal">DI1F33</mtext></mfrac><mo stretchy="true" form="postfix">)</mo></mrow><mfrac><mn>252</mn><mtext mathvariant="normal">Business Days</mtext></mfrac></msup><mo>−</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">
\text{Forward Rate} = \left(\frac{\text{DI1F23}}{\text{DI1F33}}\right)^{\frac{252}{\text{Business Days}}} - 1
</annotation></semantics></math></p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">df_fwd</span> <span class="op">&lt;-</span> <span class="va">df_fut</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    fwd <span class="op">=</span> <span class="op">(</span><span class="va">DI1F23</span> <span class="op">/</span> <span class="va">DI1F33</span><span class="op">)</span><span class="op">^</span><span class="op">(</span><span class="fl">252</span> <span class="op">/</span> <span class="va">du</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">refdate</span>, <span class="va">fwd</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/na.fail.html" class="external-link">na.omit</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>Make a graph showing the dynamics of the 10-year forward rates from
January 2023 to January 2033.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">df_fwd</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">refdate</span>, y <span class="op">=</span> <span class="va">fwd</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="st">"Date"</span>, y <span class="op">=</span> <span class="st">"Forward Rates"</span>,</span>
<span>    title <span class="op">=</span> <span class="st">"Historical 10Y Forward Rates - F23:F33"</span>,</span>
<span>    caption <span class="op">=</span> <span class="st">"Source B3 - package rb3"</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<div class="figure">
<img src="Fetching-historical-future-rates_files/figure-html/plot-forward-rates-1.png" alt="Forward Rates" width="672"><p class="caption">
Forward Rates
</p>
</div>
</div>
<div class="section level2">
<h2 id="conclusion">Conclusion<a class="anchor" aria-label="anchor" href="#conclusion"></a>
</h2>
<p>In this document, we demonstrated how to fetch and analyze historical
futures contract settlement prices from B3 (Brasil, Bolsa, Balcão). By
leveraging the <code>rb3</code> package, we were able to efficiently
download, query, and process the data to derive meaningful insights.</p>
<p>We covered the following key steps:</p>
<ol style="list-style-type: decimal">
<li>
<strong>Fetching Historical Data</strong>: We collected settlement
prices at regular intervals over a two-year period and stored them in
the <code>rb3</code> package’s internal database.</li>
<li>
<strong>Querying the Data</strong>: Using the
<code><a href="../reference/futures_get.html">futures_get()</a></code> function, we retrieved the data for further
analysis.</li>
<li>
<strong>Calculating Historical Nominal and Real Interest
Rates</strong>: We derived interest rates from the prices of DI1 and DAP
futures contracts.</li>
<li>
<strong>Implied Inflation</strong>: By comparing the real and
nominal interest rates, we calculated the forward inflation implied in
the contracts.</li>
<li>
<strong>Forward Rates</strong>: We computed the 10-year forward
rates using the DI1F23 and DI1F33 contracts.</li>
</ol>
<p>Through these analyses, we gained insights into the trends, term
structures, and other patterns in Brazilian futures markets. The ability
to efficiently process and analyze this data is crucial for market
participants, researchers, and policymakers to make informed
decisions.</p>
<p>By following the steps outlined in this document, you can replicate
the analysis and adapt it to your specific needs. The <code>rb3</code>
package provides a powerful toolset for accessing and analyzing B3
market data, enabling you to explore various aspects of the Brazilian
financial markets.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Wilson Freitas, Marcelo Perlin.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
